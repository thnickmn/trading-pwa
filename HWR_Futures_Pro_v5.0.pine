// HWR Futures Pro v5.0 - SUPERTREND STRATEGY
// Simpler, more robust approach with proven results
// Signal: SuperTrend flip + Confluence >= 4

//@version=5
indicator("HWR Futures Pro v5.0", overlay=true, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════════════════════════════
group_main = "Display"
showSignals = input.bool(true, "Show Entry Signals", group=group_main)
showLevels = input.bool(true, "Show TP/SL Levels", group=group_main)
showPanel = input.bool(true, "Show Info Panel", group=group_main)
showST = input.bool(true, "Show SuperTrend Line", group=group_main)

group_risk = "Risk Management"
minConf = input.int(4, "Min Confluence (4-6)", minval=3, maxval=6, group=group_risk)
slMult = input.float(1.5, "Stop Loss ATR", minval=0.5, maxval=3.0, step=0.25, group=group_risk)
tpMult = input.float(1.0, "Take Profit ATR", minval=0.5, maxval=3.0, step=0.25, group=group_risk)

group_st = "SuperTrend"
stLen = input.int(10, "Period", group=group_st)
stMult = input.float(2.0, "Multiplier", group=group_st)

// ═══════════════════════════════════════════════════════════════════════════════
// INDICATORS
// ═══════════════════════════════════════════════════════════════════════════════
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
atr = ta.atr(14)
rsi = ta.rsi(close, 14)
[macd, signal, _] = ta.macd(close, 12, 26, 9)
volAvg = ta.sma(volume, 20)

// SuperTrend
[stVal, stDir] = ta.supertrend(stMult, stLen)
bullST = stDir < 0
bearST = stDir > 0
stFlipBull = bullST and not bullST[1]
stFlipBear = bearST and not bearST[1]

// ═══════════════════════════════════════════════════════════════════════════════
// CONFLUENCE (5 FACTORS - excluding SuperTrend since it's the trigger)
// ═══════════════════════════════════════════════════════════════════════════════
bullConf = 0
bearConf = 0

// 1. EMA Stack
bullConf += ema9 > ema21 and ema21 > ema50 ? 1 : 0
bearConf += ema9 < ema21 and ema21 < ema50 ? 1 : 0

// 2. Price vs EMA21
bullConf += close > ema21 ? 1 : 0
bearConf += close < ema21 ? 1 : 0

// 3. RSI
bullConf += rsi > 45 and rsi < 75 ? 1 : 0
bearConf += rsi < 55 and rsi > 25 ? 1 : 0

// 4. MACD
bullConf += macd > signal ? 1 : 0
bearConf += macd < signal ? 1 : 0

// 5. Volume
bullConf += volume > volAvg * 0.8 ? 1 : 0
bearConf += volume > volAvg * 0.8 ? 1 : 0

// ═══════════════════════════════════════════════════════════════════════════════
// SIGNALS: SuperTrend Flip + Confluence
// ═══════════════════════════════════════════════════════════════════════════════
longSig = stFlipBull and bullConf >= minConf
shortSig = stFlipBear and bearConf >= minConf

// ═══════════════════════════════════════════════════════════════════════════════
// TRADE MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════════
var float entry = na
var float sl = na
var float tp = na
var bool inLong = false
var bool inShort = false
var int wins = 0
var int losses = 0

// Long Entry
if longSig and not inLong and not inShort
    entry := close
    sl := close - atr * slMult
    tp := close + atr * tpMult
    inLong := true

// Short Entry
if shortSig and not inLong and not inShort
    entry := close
    sl := close + atr * slMult
    tp := close - atr * tpMult
    inShort := true

// Long Exit
if inLong
    if high >= tp
        wins += 1
        label.new(bar_index, tp, "W", color=color.green, textcolor=color.white, style=label.style_label_down, size=size.tiny)
        entry := na
        sl := na
        tp := na
        inLong := false
    else if low <= sl
        losses += 1
        label.new(bar_index, sl, "L", color=color.red, textcolor=color.white, style=label.style_label_up, size=size.tiny)
        entry := na
        sl := na
        tp := na
        inLong := false

// Short Exit
if inShort
    if low <= tp
        wins += 1
        label.new(bar_index, tp, "W", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.tiny)
        entry := na
        sl := na
        tp := na
        inShort := false
    else if high >= sl
        losses += 1
        label.new(bar_index, sl, "L", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.tiny)
        entry := na
        sl := na
        tp := na
        inShort := false

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTS
// ═══════════════════════════════════════════════════════════════════════════════
stColor = bullST ? color.green : color.red
plot(showST ? stVal : na, "SuperTrend", stColor, 2)

plotshape(showSignals and longSig, "Long", shape.triangleup, location.belowbar, color.green, size=size.normal)
plotshape(showSignals and shortSig, "Short", shape.triangledown, location.abovebar, color.red, size=size.normal)

plot(showLevels and (inLong or inShort) ? tp : na, "TP", color.green, 2, plot.style_linebr)
plot(showLevels and (inLong or inShort) ? sl : na, "SL", color.red, 2, plot.style_linebr)
plot(showLevels and (inLong or inShort) ? entry : na, "Entry", color.blue, 1, plot.style_linebr)

// ═══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ═══════════════════════════════════════════════════════════════════════════════
if showPanel and barstate.islast
    total = wins + losses
    wr = total > 0 ? wins * 100.0 / total : 0.0
    conf = bullST ? bullConf : bearConf
    status = inLong ? "LONG" : inShort ? "SHORT" : "FLAT"

    var table pan = table.new(position.top_right, 2, 5, bgcolor=color.new(#000000, 85))
    table.cell(pan, 0, 0, "Status", text_color=color.gray)
    table.cell(pan, 1, 0, status, text_color=inLong ? color.green : inShort ? color.red : color.white)
    table.cell(pan, 0, 1, "Confluence", text_color=color.gray)
    table.cell(pan, 1, 1, str.tostring(conf) + "/5", text_color=conf >= minConf ? color.green : color.orange)
    table.cell(pan, 0, 2, "Wins", text_color=color.gray)
    table.cell(pan, 1, 2, str.tostring(wins), text_color=color.green)
    table.cell(pan, 0, 3, "Losses", text_color=color.gray)
    table.cell(pan, 1, 3, str.tostring(losses), text_color=color.red)
    table.cell(pan, 0, 4, "Win Rate", text_color=color.gray)
    table.cell(pan, 1, 4, str.tostring(wr, "#.#") + "%", text_color=wr >= 50 ? color.green : color.red)

// ═══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════
alertcondition(longSig, "Long", "HWR LONG Signal")
alertcondition(shortSig, "Short", "HWR SHORT Signal")
